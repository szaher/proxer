name: Desktop macOS Build

on:
  workflow_dispatch:
  push:
    tags:
      - "desktop-agent-v*"
  release:
    types:
      - published

permissions:
  contents: write

jobs:
  build-macos-app:
    name: Build macOS App Bundle
    runs-on: macos-latest
    env:
      PROXER_CODESIGN_IDENTITY: ${{ secrets.PROXER_CODESIGN_IDENTITY }}
      PROXER_NOTARY_PROFILE: ${{ secrets.PROXER_NOTARY_PROFILE }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: agentweb/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build desktop React assets
        working-directory: agentweb
        run: |
          npm ci
          npm run sync-native-static

      - name: Build macOS app bundle
        env:
          PROXER_APP_VERSION: ${{ github.ref_name }}
        run: ./scripts/desktop/macos/build_app.sh

      - name: Notarize app bundle
        if: ${{ env.PROXER_NOTARY_PROFILE != '' || (env.APPLE_ID != '' && env.APPLE_TEAM_ID != '' && env.APPLE_APP_PASSWORD != '') }}
        run: ./scripts/desktop/macos/notarize_app.sh

      - name: Package app zip
        run: |
          ditto -c -k --keepParent --sequesterRsrc \
            "output/desktop/macos/Proxer Agent.app" \
            "output/desktop/macos/proxer-agent-macos.app.zip"

      - name: Collect release metadata
        run: |
          ./scripts/desktop/release_artifacts.sh \
            output/desktop/macos/release \
            output/desktop/macos/proxer-agent-macos.app.zip

      - name: Verify release metadata files
        run: |
          test -f output/desktop/macos/release/checksums.txt
          test -f output/desktop/macos/release/release-manifest.json
          test -f output/desktop/macos/release/release-notes.md
          test -f output/desktop/macos/release/sbom-go.cdx.json

      - name: Upload app artifact
        uses: actions/upload-artifact@v4
        with:
          name: proxer-agent-macos-app
          path: output/desktop/macos/release/

      - name: Stage release assets for upload
        if: github.event_name == 'release'
        run: |
          set -euo pipefail
          src="output/desktop/macos/release"
          dst="output/desktop/macos/release-upload"
          rm -rf "$dst"
          mkdir -p "$dst"
          for path in "$src"/*; do
            name="$(basename "$path")"
            case "$name" in
              checksums.txt|release-manifest.json|release-notes.md|sbom-go.cdx.json|sbom-npm.cdx.json)
                cp "$path" "$dst/macos-$name"
                ;;
              *)
                cp "$path" "$dst/$name"
                ;;
            esac
          done

      - name: Publish release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            output/desktop/macos/release-upload/*
          fail_on_unmatched_files: true

      - name: Upload macOS packaging diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: proxer-agent-macos-diagnostics
          path: output/desktop/macos/
          if-no-files-found: ignore
