name: Desktop macOS Build

on:
  workflow_dispatch:
  push:
    tags:
      - "desktop-agent-v*"

jobs:
  build-macos-app:
    name: Build macOS App Bundle
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: agentweb/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build desktop React assets
        working-directory: agentweb
        run: |
          npm ci
          npm run sync-native-static

      - name: Build macOS app bundle
        env:
          PROXER_CODESIGN_IDENTITY: ${{ secrets.PROXER_CODESIGN_IDENTITY }}
          PROXER_APP_VERSION: ${{ github.ref_name }}
        run: ./scripts/desktop/macos/build_app.sh

      - name: Notarize app bundle
        if: ${{ secrets.PROXER_NOTARY_PROFILE != '' || (secrets.APPLE_ID != '' && secrets.APPLE_TEAM_ID != '' && secrets.APPLE_APP_PASSWORD != '') }}
        env:
          PROXER_NOTARY_PROFILE: ${{ secrets.PROXER_NOTARY_PROFILE }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: ./scripts/desktop/macos/notarize_app.sh

      - name: Package app zip
        run: |
          ditto -c -k --keepParent --sequesterRsrc \
            "output/desktop/macos/Proxer Agent.app" \
            "output/desktop/macos/proxer-agent-macos.app.zip"

      - name: Collect release metadata
        run: |
          ./scripts/desktop/release_artifacts.sh \
            output/desktop/macos/release \
            output/desktop/macos/proxer-agent-macos.app.zip

      - name: Upload app artifact
        uses: actions/upload-artifact@v4
        with:
          name: proxer-agent-macos-app
          path: output/desktop/macos/release/
