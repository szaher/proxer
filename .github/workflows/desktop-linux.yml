name: Desktop Linux Build

on:
  workflow_dispatch:
  push:
    tags:
      - "desktop-agent-v*"

jobs:
  build-linux-appimage:
    name: Build Linux AppImage
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: agentweb/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install Linux desktop build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            file \
            squashfs-tools \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            patchelf \
            desktop-file-utils \
            appstream

      - name: Install appimagetool
        id: appimagetool
        run: |
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64|amd64)
              APPIMAGE_ARCH="x86_64"
              ;;
            aarch64|arm64)
              APPIMAGE_ARCH="aarch64"
              ;;
            *)
              echo "unsupported runner arch: $ARCH" >&2
              exit 1
              ;;
          esac

          echo "target_arch=$APPIMAGE_ARCH" >> "$GITHUB_OUTPUT"
          curl -fL -o /tmp/appimagetool.AppImage \
            "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-${APPIMAGE_ARCH}.AppImage"
          chmod +x /tmp/appimagetool.AppImage

      - name: Build desktop React assets
        working-directory: agentweb
        run: |
          npm ci
          npm run sync-native-static

      - name: Build AppImage
        env:
          APPIMAGE_EXTRACT_AND_RUN: "1"
          PROXER_APPIMAGETOOL: /tmp/appimagetool.AppImage
          PROXER_TARGET_ARCH: ${{ steps.appimagetool.outputs.target_arch }}
          PROXER_APP_VERSION: ${{ github.ref_name }}
        run: ./scripts/desktop/linux/build_appimage.sh

      - name: AppImage smoke test
        env:
          PROXER_BUILD_DIR: output/desktop/linux
        run: ./scripts/desktop/linux/e2e_host_smoke.sh

      - name: Collect release metadata
        run: |
          APPIMAGE="$(ls -1 output/desktop/linux/*.AppImage | head -n1)"
          ./scripts/desktop/release_artifacts.sh \
            output/desktop/linux/release \
            "$APPIMAGE" \
            output/desktop/linux/smoke-help.txt

      - name: Verify release metadata files
        run: |
          test -f output/desktop/linux/release/checksums.txt
          test -f output/desktop/linux/release/release-manifest.json
          test -f output/desktop/linux/release/release-notes.md
          test -f output/desktop/linux/release/sbom-go.cdx.json

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: proxer-agent-linux-appimage
          path: output/desktop/linux/release/

      - name: Upload Linux smoke diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: proxer-agent-linux-smoke-diagnostics
          path: output/desktop/linux/
          if-no-files-found: ignore
