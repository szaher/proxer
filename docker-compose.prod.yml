services:
  gateway:
    image: ${PROXER_GATEWAY_IMAGE:-ghcr.io/szaher/proxer/gateway}:${PROXER_IMAGE_TAG:-latest}
    pull_policy: always
    restart: unless-stopped
    environment:
      PROXER_LISTEN_ADDR: ":8080"
      PROXER_PUBLIC_BASE_URL: "${PROXER_PUBLIC_BASE_URL:?set PROXER_PUBLIC_BASE_URL}"
      PROXER_PUBLIC_SIGNUP_ENABLED: "${PROXER_PUBLIC_SIGNUP_ENABLED:-false}"
      PROXER_PUBLIC_SIGNUP_RPM: "${PROXER_PUBLIC_SIGNUP_RPM:-20}"
      PROXER_DEV_MODE: "false"
      PROXER_AGENT_TOKEN: "${PROXER_AGENT_TOKEN:?set PROXER_AGENT_TOKEN}"
      PROXER_REQUEST_TIMEOUT: "${PROXER_REQUEST_TIMEOUT:-30s}"
      PROXER_PROXY_REQUEST_TIMEOUT: "${PROXER_PROXY_REQUEST_TIMEOUT:-30s}"
      PROXER_MAX_REQUEST_BODY_BYTES: "${PROXER_MAX_REQUEST_BODY_BYTES:-10485760}"
      PROXER_MAX_RESPONSE_BODY_BYTES: "${PROXER_MAX_RESPONSE_BODY_BYTES:-20971520}"
      PROXER_MAX_PENDING_PER_SESSION: "${PROXER_MAX_PENDING_PER_SESSION:-1024}"
      PROXER_MAX_PENDING_GLOBAL: "${PROXER_MAX_PENDING_GLOBAL:-10000}"
      PROXER_PAIR_TOKEN_TTL: "${PROXER_PAIR_TOKEN_TTL:-10m}"
      PROXER_SUPER_ADMIN_USER: "${PROXER_SUPER_ADMIN_USER:?set PROXER_SUPER_ADMIN_USER}"
      PROXER_SUPER_ADMIN_PASSWORD: "${PROXER_SUPER_ADMIN_PASSWORD:?set PROXER_SUPER_ADMIN_PASSWORD}"
      PROXER_SESSION_TTL: "${PROXER_SESSION_TTL:-24h}"
      PROXER_STORAGE_DRIVER: "sqlite"
      PROXER_SQLITE_PATH: "/data/proxer.db"
      PROXER_MEMBER_WRITE_ENABLED: "${PROXER_MEMBER_WRITE_ENABLED:-false}"
      PROXER_TLS_KEY_ENCRYPTION_KEY: "${PROXER_TLS_KEY_ENCRYPTION_KEY:?set PROXER_TLS_KEY_ENCRYPTION_KEY}"
      PROXER_PUBLIC_DOWNLOAD_CACHE_TTL: "${PROXER_PUBLIC_DOWNLOAD_CACHE_TTL:-15m}"
      PROXER_GITHUB_RELEASE_REPO: "${PROXER_GITHUB_RELEASE_REPO:-szaher/proxer}"
      PROXER_GITHUB_RELEASE_TAG: "${PROXER_GITHUB_RELEASE_TAG:-}"
      PROXER_GITHUB_TOKEN: "${PROXER_GITHUB_TOKEN:-}"
    ports:
      - "${PROXER_HTTP_PORT:-8080}:8080"
    volumes:
      - gateway-data:/data

  agent:
    image: ${PROXER_AGENT_IMAGE:-ghcr.io/szaher/proxer/agent}:${PROXER_IMAGE_TAG:-latest}
    pull_policy: always
    restart: unless-stopped
    profiles:
      - demo-agent
    depends_on:
      - gateway
    environment:
      PROXER_GATEWAY_BASE_URL: "${PROXER_GATEWAY_INTERNAL_URL:-http://gateway:8080}"
      PROXER_AGENT_TOKEN: "${PROXER_AGENT_TOKEN:?set PROXER_AGENT_TOKEN}"
      PROXER_AGENT_ID: "${PROXER_AGENT_ID:-prod-agent}"
      PROXER_HEARTBEAT_INTERVAL: "${PROXER_HEARTBEAT_INTERVAL:-10s}"
      PROXER_AGENT_REQUEST_TIMEOUT: "${PROXER_AGENT_REQUEST_TIMEOUT:-45s}"
      PROXER_AGENT_POLL_WAIT: "${PROXER_AGENT_POLL_WAIT:-25s}"
      PROXER_MAX_RESPONSE_BODY_BYTES: "${PROXER_MAX_RESPONSE_BODY_BYTES:-20971520}"
      PROXER_AGENT_TUNNELS: "${PROXER_AGENT_TUNNELS:-}"
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  gateway-data:
